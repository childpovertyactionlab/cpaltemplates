---
title: "Interactive Charts"
subtitle: "Creating interactive visualizations with ggiraph"
---

```{r}
#| label: setup
#| include: false
library(cpaltemplates)
library(ggplot2)
library(dplyr)
```

## Overview

cpaltemplates provides 7 functions for creating interactive visualizations using the ggiraph package. These functions add tooltips, hover effects, and click actions to your ggplot2 charts.

::: {.callout-tip}
## Try It!
Hover over the data points in the charts below to see interactive tooltips.
:::

---

## Quick Start

```{r}
#| label: quick-start-interactive
#| code-fold: show
library(ggiraph)

# Create data with tooltips
mtcars_named <- mtcars |>
  mutate(
    car_name = rownames(mtcars),
    tooltip = paste0(
      "<strong>", car_name, "</strong><br>",
      "MPG: ", mpg, "<br>",
      "Weight: ", wt, " tons"
    )
  )

# Create an interactive plot
p <- ggplot(mtcars_named, aes(x = wt, y = mpg)) +
  geom_point_interactive(
    aes(tooltip = tooltip, data_id = car_name),
    size = 3,
    color = "#007A8C"
  ) +
  labs(
    title = "Interactive Scatter Plot",
    subtitle = "Hover over points to see details",
    x = "Weight (1000 lbs)",
    y = "Miles per Gallon"
  ) +
  theme_cpal()

cpal_interactive(p)
```

---

## Interactive Examples

### Colored by Group

```{r}
#| label: interactive-colored
mtcars_colored <- mtcars |>
  mutate(
    car_name = rownames(mtcars),
    tooltip = paste0(
      "<strong>", car_name, "</strong><br>",
      "Cylinders: ", cyl, "<br>",
      "MPG: ", round(mpg, 1), "<br>",
      "Horsepower: ", hp
    )
  )

p_colored <- ggplot(mtcars_colored, aes(x = wt, y = mpg, color = factor(cyl))) +
  geom_point_interactive(
    aes(tooltip = tooltip, data_id = car_name),
    size = 4,
    alpha = 0.8
  ) +
  scale_color_cpal("main_3") +
  labs(
    title = "Fuel Efficiency by Weight",
    subtitle = "Colored by cylinder count - hover for details",
    x = "Weight (1000 lbs)",
    y = "Miles per Gallon",
    color = "Cylinders"
  ) +
  theme_cpal()

cpal_interactive(p_colored)
```

### Interactive Box Plot with Points

```{r}
#| label: interactive-boxplot
boxplot_data <- mtcars |>
  mutate(
    cyl_factor = factor(cyl),
    tooltip = paste0(
      "<strong>", rownames(mtcars), "</strong><br>",
      "MPG: ", mpg, "<br>",
      "Cylinders: ", cyl, "<br>",
      "HP: ", hp
    )
  )

p_box <- ggplot(boxplot_data, aes(x = cyl_factor, y = mpg, fill = cyl_factor)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_point_interactive(
    aes(tooltip = tooltip, data_id = rownames(mtcars)),
    position = position_jitter(width = 0.2, seed = 42),
    size = 3, alpha = 0.8
  ) +
  scale_fill_cpal("main_3") +
  labs(
    title = "Fuel Efficiency Distribution by Cylinder Count",
    subtitle = "Hover over points for vehicle details",
    x = "Number of Cylinders",
    y = "Miles per Gallon"
  ) +
  theme_cpal() +
  theme(legend.position = "none")

cpal_interactive(p_box)
```

### Interactive Line Chart

```{r}
#| label: interactive-line
# Create time series data
set.seed(123)
time_data <- data.frame(
  year = rep(2018:2023, 3),
  value = c(
    cumsum(c(100, rnorm(5, 8, 3))),
    cumsum(c(80, rnorm(5, 6, 4))),
    cumsum(c(60, rnorm(5, 10, 5)))
  ),
  group = rep(c("Region A", "Region B", "Region C"), each = 6)
) |>
  mutate(
    tooltip = paste0(
      "<strong>", group, "</strong><br>",
      "Year: ", year, "<br>",
      "Value: ", round(value, 1)
    )
  )

p_line <- ggplot(time_data, aes(x = year, y = value, color = group, group = group)) +
  geom_line_interactive(aes(data_id = group), linewidth = 1.2) +
  geom_point_interactive(
    aes(tooltip = tooltip, data_id = group),
    size = 4
  ) +
  scale_color_cpal("main_3") +
  labs(
    title = "Growth Trends by Region",
    subtitle = "Hover over points to see values",
    x = "Year",
    y = "Cumulative Value",
    color = "Region"
  ) +
  theme_cpal()

cpal_interactive(p_line)
```

---

## Main Function: `cpal_interactive()`

Convert any ggplot with interactive geoms to a fully interactive visualization.

```r
cpal_interactive(
  plot,
  width_svg = 8,
  height_svg = 5,
  ...
)
```

#### Arguments

| Argument | Description | Default |
|----------|-------------|---------|
| `plot` | A ggplot2 object with interactive geoms | (required) |
| `width_svg` | Width in inches | 8 |
| `height_svg` | Height in inches | 5 |
| `...` | Additional arguments to `girafe()` |

#### Styling Features

- CPAL-branded hover colors
- Smooth transitions
- Consistent tooltip styling
- Font integration

#### Examples

```r
library(ggplot2)
library(ggiraph)

# Basic interactive plot
p <- ggplot(mtcars, aes(x = wt, y = mpg, color = factor(cyl))) +
  geom_point_interactive(
    aes(tooltip = paste("MPG:", mpg, "<br>Weight:", wt)),
    size = 3
  ) +
  scale_color_cpal("main_3") +
  theme_cpal()

cpal_interactive(p)

# Custom dimensions
cpal_interactive(p, width_svg = 10, height_svg = 6)
```

---

## Interactive Geom Wrappers

### `cpal_point_interactive()`

Interactive points with CPAL defaults.

```r
cpal_point_interactive(
  mapping = NULL,
  data = NULL,
  tooltip_var = NULL,
  onclick_var = NULL,
  data_id_var = NULL,
  ...
)
```

#### Arguments

| Argument | Description |
|----------|-------------|
| `mapping` | Aesthetic mappings |
| `data` | Data frame |
| `tooltip_var` | Column name for tooltip text |
| `onclick_var` | Column name for click action (JavaScript) |
| `data_id_var` | Column name for element ID (for highlighting) |
| `...` | Additional arguments to `geom_point_interactive()` |

#### Examples

```r
# Using the wrapper
mtcars$name <- rownames(mtcars)

p <- ggplot(mtcars, aes(x = wt, y = mpg, color = factor(cyl))) +
  cpal_point_interactive(tooltip_var = "name", size = 3) +
  scale_color_cpal("main_3") +
  theme_cpal()

cpal_interactive(p)

# With data ID for linked highlighting
p <- ggplot(mtcars, aes(x = wt, y = mpg, color = factor(cyl))) +
  cpal_point_interactive(
    tooltip_var = "name",
    data_id_var = "cyl"  # Hovering highlights all same-cylinder cars
  ) +
  scale_color_cpal("main_3") +
  theme_cpal()

cpal_interactive(p)
```

---

### `cpal_line_interactive()`

Interactive lines for time series and trend data.

```r
cpal_line_interactive(
  mapping = NULL,
  data = NULL,
  tooltip_var = NULL,
  onclick_var = NULL,
  data_id_var = NULL,
  ...
)
```

#### Examples

```r
# Time series data
library(dplyr)

time_data <- data.frame(
  date = seq.Date(as.Date("2020-01-01"), by = "month", length.out = 24),
  value = cumsum(rnorm(24, 5, 2)),
  group = rep(c("A", "B"), each = 12)
)

p <- ggplot(time_data, aes(x = date, y = value, color = group)) +
  cpal_line_interactive(
    aes(tooltip = paste(format(date, "%b %Y"), "\nValue:", round(value, 1))),
    linewidth = 1.2
  ) +
  scale_color_cpal("compare") +
  theme_cpal()

cpal_interactive(p)
```

---

### `cpal_col_interactive()`
Interactive columns for bar charts.

```r
cpal_col_interactive(
  mapping = NULL,
  data = NULL,
  tooltip_var = NULL,
  onclick_var = NULL,
  data_id_var = NULL,
  ...
)
```

#### Examples

```r
# Bar chart with tooltips
bar_data <- mtcars |>
  group_by(cyl) |>
  summarise(
    avg_mpg = mean(mpg),
    count = n(),
    .groups = "drop"
  ) |>
  mutate(
    tooltip_text = paste0(
      "Cylinders: ", cyl, "\n",
      "Avg MPG: ", round(avg_mpg, 1), "\n",
      "Count: ", count
    )
  )

p <- ggplot(bar_data, aes(x = factor(cyl), y = avg_mpg, fill = factor(cyl))) +
  cpal_col_interactive(aes(tooltip = tooltip_text)) +
  scale_fill_cpal("main_3") +
  labs(x = "Cylinders", y = "Average MPG") +
  theme_cpal() +
  theme(legend.position = "none")

cpal_interactive(p)
```

---

### `cpal_polygon_interactive()`

Interactive polygons for maps and shapes.

```r
cpal_polygon_interactive(
  mapping = NULL,
  data = NULL,
  tooltip_var = NULL,
  onclick_var = NULL,
  data_id_var = NULL,
  ...
)
```

#### Examples

```r
# With sf data
library(sf)

# Assuming you have geographic data
ggplot(geo_data) +
  cpal_polygon_interactive(
    aes(fill = value, tooltip = region_name)
  ) +
  scale_fill_cpal_c("teal_seq_5") +
  theme_cpal_map()
```

---

## Tooltip Customization

### HTML Tooltips

Tooltips support HTML formatting:

```r
mtcars$tooltip <- paste0(
  "<strong>", rownames(mtcars), "</strong><br>",
  "<em>Performance</em><br>",
  "MPG: ", mtcars$mpg, "<br>",
  "HP: ", mtcars$hp, "<br>",
  "<span style='color:#007A8C;'>Cylinders: ", mtcars$cyl, "</span>"
)

p <- ggplot(mtcars, aes(x = wt, y = mpg)) +
  geom_point_interactive(aes(tooltip = tooltip), size = 3) +
  theme_cpal()

cpal_interactive(p)
```

### Styling Tooltips

```r
cpal_interactive(
  p,
  options = list(
    opts_tooltip(
      css = "background-color:#004855;color:white;padding:10px;border-radius:5px;",
      use_fill = FALSE
    )
  )
)
```

---

## Click Actions

### JavaScript onclick

```r
mtcars$onclick <- sprintf(
  "window.open('https://google.com/search?q=%s')",
  gsub(" ", "+", rownames(mtcars))
)

p <- ggplot(mtcars, aes(x = wt, y = mpg)) +
  geom_point_interactive(
    aes(tooltip = rownames(mtcars), onclick = onclick),
    size = 3
  ) +
  theme_cpal()

cpal_interactive(p)
```

### Shiny Integration

```r
# In Shiny, use data_id for server-side handling
p <- ggplot(mtcars, aes(x = wt, y = mpg)) +
  geom_point_interactive(
    aes(tooltip = rownames(mtcars), data_id = rownames(mtcars)),
    size = 3
  ) +
  theme_cpal()

# Server
output$plot <- renderGirafe({
  cpal_interactive(p)
})

observeEvent(input$plot_selected, {
  selected_car <- input$plot_selected
  # Do something with the selection
})
```

---

## Linked Highlighting

Use `data_id` to link elements across the visualization:

```r
# All points with same cylinder count highlight together
p <- ggplot(mtcars, aes(x = wt, y = mpg, color = factor(cyl))) +
  geom_point_interactive(
    aes(
      tooltip = rownames(mtcars),
      data_id = factor(cyl)  # Link by cylinder count
    ),
    size = 3
  ) +
  scale_color_cpal("main_3") +
  theme_cpal()

cpal_interactive(p)
```

---

## Multiple Geoms

Combine multiple interactive geoms:

```r
p <- ggplot(mtcars, aes(x = wt, y = mpg)) +
  geom_point_interactive(
    aes(tooltip = rownames(mtcars), data_id = factor(cyl)),
    size = 3,
    color = "#007A8C"
  ) +
  geom_smooth_interactive(
    aes(tooltip = "Trend line"),
    method = "lm",
    color = "#004855",
    fill = "#D8EFF4"
  ) +
  theme_cpal()

cpal_interactive(p)
```

---

## Interactive in Shiny

### Basic Setup

```r
library(shiny)
library(ggiraph)
library(cpaltemplates)

ui <- fluidPage(
  theme = cpal_dashboard_theme(),
  girafeOutput("interactive_plot")
)

server <- function(input, output) {
  output$interactive_plot <- renderGirafe({
    p <- ggplot(mtcars, aes(x = wt, y = mpg, color = factor(cyl))) +
      geom_point_interactive(aes(tooltip = rownames(mtcars))) +
      scale_color_cpal("main_3") +
      theme_cpal()

    cpal_interactive(p)
  })
}

shinyApp(ui, server)
```

### With Selection

```r
server <- function(input, output) {
  output$interactive_plot <- renderGirafe({
    mtcars$id <- rownames(mtcars)

    p <- ggplot(mtcars, aes(x = wt, y = mpg)) +
      geom_point_interactive(
        aes(tooltip = id, data_id = id),
        size = 3,
        color = "#007A8C"
      ) +
      theme_cpal()

    girafe(
      ggobj = p,
      options = list(
        opts_selection(type = "single", css = "fill:#C3257B;stroke:#C3257B;")
      )
    )
  })

  output$selected <- renderText({
    paste("Selected:", input$interactive_plot_selected)
  })
}
```

---

## Font Setup for Interactive

Interactive plots require special font handling:

```r
# Set up fonts for interactive use
setup_cpal_google_fonts()

# Verify interactive font
cpal_font_family("interactive")
#> [1] "Inter"

# If fonts aren't working, try:
if (requireNamespace("gdtools", quietly = TRUE)) {
  gdtools::register_gfont("Inter")
  gdtools::register_gfont("Roboto")
}
```

---

## Performance Tips

### Large Datasets

```r
# For large datasets, sample or aggregate
large_data_sample <- large_data |>
  slice_sample(n = 1000)

# Or aggregate
aggregated <- large_data |>
  group_by(region) |>
  summarise(across(everything(), mean))
```

### Optimize SVG Size

```r
# Smaller dimensions for faster rendering
cpal_interactive(p, width_svg = 6, height_svg = 4)
```

### Reduce Tooltip Complexity

```r
# Simple tooltips render faster than HTML-heavy ones
aes(tooltip = name)  # Fast
aes(tooltip = complex_html)  # Slower
```

---

## Complete Example

```r
library(cpaltemplates)
library(ggplot2)
library(ggiraph)
library(dplyr)

# Prepare data with tooltips
plot_data <- mtcars |>
  mutate(
    name = rownames(mtcars),
    cylinders = factor(cyl),
    tooltip = paste0(
      "<strong>", name, "</strong><br>",
      "MPG: ", mpg, "<br>",
      "Horsepower: ", hp, "<br>",
      "Weight: ", wt, " Ã— 1000 lbs"
    )
  )

# Create interactive visualization
p <- ggplot(plot_data, aes(x = wt, y = mpg, color = cylinders)) +
  geom_point_interactive(
    aes(tooltip = tooltip, data_id = cylinders),
    size = 4,
    alpha = 0.8
  ) +
  scale_color_cpal("main_3") +
  labs(
    title = "Vehicle Fuel Efficiency",
    subtitle = "Hover over points for details",
    x = "Weight (1,000 lbs)",
    y = "Miles per Gallon",
    color = "Cylinders"
  ) +
  theme_cpal()

# Render interactive
cpal_interactive(p)
```

---

## Troubleshooting

### Fonts Not Rendering

```r
# Install gdtools for font support
install.packages("gdtools")

# Register fonts
setup_cpal_google_fonts()
gdtools::register_gfont("Inter")
```

### Tooltips Not Appearing

```r
# Check that you're using interactive geoms
geom_point_interactive()  # Correct
geom_point()              # Won't show tooltips
```

### Plot Not Displaying

```r
# Ensure ggiraph is loaded
library(ggiraph)

# Use cpal_interactive() or girafe()
cpal_interactive(p)  # Correct
print(p)             # Static only
```

---

## Next Steps

- [Maps & Geographic](maps-geographic.qmd) - Interactive maps
- [Shiny Dashboards](shiny-dashboards.qmd) - Dashboard integration
- [Themes & Styling](themes-styling.qmd) - Theme customization
