{
  "hash": "d2087f6899f68ad59cb1b9ee2e12ce38",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Maps & Geographic\"\nsubtitle: \"Creating interactive maps with CPAL styling using mapgl\"\n---\n\n\n\n\nInteractive maps are essential for exploring geographic data and communicating spatial patterns. The cpaltemplates package integrates with the [mapgl](https://walker-data.com/mapgl/) package to create professional, CPAL-branded web maps using Mapbox GL JS.\n\n::: {.callout-note}\n## mapgl Maps in Quarto\nmapgl maps are interactive HTML widgets that don't render in static Quarto documents. The examples below show screenshots of the output. For interactive maps, use mapgl in **Shiny applications** or render your Quarto document as an HTML file with `format: html`.\n:::\n\n## Setup\n\n### Mapbox Access Token\n\nInteractive maps require a Mapbox access token. Mapbox offers a generous free tier for development and small-scale use.\n\n1. Create a free account at [mapbox.com](https://www.mapbox.com/)\n2. Navigate to **Account** > **Tokens**\n3. Copy your **Default public token** (starts with `pk.`)\n4. Add it to your `.Renviron` file:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"false\"}\n# Open your .Renviron file\nusethis::edit_r_environ()\n\n# Add this line (replace with your actual token):\n# MAPBOX_PUBLIC_TOKEN=\"pk.your_token_here\"\n\n# Save the file and restart R\n```\n:::\n\n\n::: {.callout-tip}\n## Verify Your Token\nAfter restarting R, verify your token is set:\n```r\nSys.getenv(\"MAPBOX_PUBLIC_TOKEN\")\n```\n:::\n\n## Basemap Themes\n\nInitialize a Mapbox GL map with `cpal_mapgl()`. Four CPAL-branded basemap themes are available:\n\n| Theme | Best For |\n|-------|----------|\n| `\"light\"` | Most data visualizations, reports (default) |\n| `\"dark\"` | Dashboards, dark mode applications |\n| `\"satellite\"` | Land use analysis, geographic context |\n| `\"minimal\"` | Dense data overlays, monochrome aesthetic |\n\n### Light Theme (Default)\n\nBest for most data visualizations and reports:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\ncpal_mapgl() |>\n  fit_bounds(nc)\n```\n:::\n\n\n![Light theme basemap](images/maps/cpal-mapgl-light.png){fig-alt=\"CPAL light theme basemap\"}\n\n### Dark Theme\n\nIdeal for dashboards and dark mode applications:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\ncpal_mapgl(theme = \"dark\") |>\n  fit_bounds(nc)\n```\n:::\n\n\n![Dark theme basemap](images/maps/cpal-mapgl-dark.png){fig-alt=\"CPAL dark theme basemap\"}\n\n## Choropleth Maps\n\nChoropleth maps shade regions based on data values. Use `add_fill_layer()` with `interpolate_palette()` for continuous color scales.\n\n### Basic Choropleth\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\ncpal_mapgl() |>\n  add_fill_layer(\n    id = \"counties\",\n    source = nc,\n    fill_color = \"#008097\",\n    fill_opacity = 0.7,\n    fill_outline_color = \"#FFFFFF\",\n    popup = \"NAME\",\n    tooltip = \"NAME\"\n  ) |>\n  fit_bounds(nc)\n```\n:::\n\n\n![Basic choropleth with single CPAL color](images/maps/choropleth-basic.png){fig-alt=\"Choropleth map with CPAL teal fill color\"}\n\n### With Color Scale and Styled Legend\n\nFor continuous data, use `interpolate_palette()` with CPAL sequential colors and `cpal_legend_style()` for branded legends:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Get CPAL sequential palette\nseq_colors <- cpal_colors(\"midnight_seq_5\")\n\n# Create continuous color scale\ncolor_scale <- interpolate_palette(\n  data = nc,\n  column = \"poverty_rate\",\n  method = \"quantile\",\n  n = 5,\n  colors = seq_colors\n)\n\n# Apply to map with styled legend\ncpal_mapgl() |>\n  add_fill_layer(\n    id = \"poverty\",\n    source = nc,\n    fill_color = color_scale$expression,\n    fill_opacity = 0.7,\n    fill_outline_color = \"#FFFFFF\",\n    popup = \"popup_html\",\n    tooltip = \"NAME\"\n  ) |>\n  add_legend(\n    \"Poverty Rate (%)\",\n    values = get_legend_labels(color_scale, digits = 1),\n    colors = get_legend_colors(color_scale),\n    type = \"continuous\",\n    style = cpal_legend_style()\n  ) |>\n  fit_bounds(nc)\n```\n:::\n\n\n![Choropleth with CPAL sequential colors and styled legend](images/maps/choropleth-styled-legend.png){fig-alt=\"Choropleth map with midnight sequential color scale and styled legend\"}\n\n### Classification Methods\n\n| Method | Use When |\n|--------|----------|\n| `\"quantile\"` | Data is skewed; want equal counts in each bin |\n| `\"equal\"` | Data is evenly distributed; want equal-width bins |\n| `\"jenks\"` | Want natural groupings that minimize within-group variance |\n\n## Point Maps\n\nUse `add_circle_layer()` for point data. Supports color encoding, size encoding, and clustering.\n\n### Basic Points\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\ncpal_mapgl() |>\n  add_fill_layer(\n    id = \"background\",\n    source = nc,\n    fill_color = \"#EBEBEB\",\n    fill_outline_color = \"#FFFFFF\"\n  ) |>\n  add_circle_layer(\n    id = \"locations\",\n    source = sample_points,\n    circle_color = \"#E86A50\",\n    circle_radius = 8,\n    circle_opacity = 0.8,\n    circle_stroke_color = \"#FFFFFF\",\n    circle_stroke_width = 2,\n    popup = \"name\"\n  ) |>\n  fit_bounds(nc)\n```\n:::\n\n\n![Basic point map with CPAL coral circles](images/maps/points-basic.png){fig-alt=\"Point map showing locations as coral circles on gray background\"}\n\n### Colored by Category\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Create color expression for categories\ncategory_colors <- list(\n  \"match\",\n  list(\"get\", \"category\"),\n  \"Type A\", \"#004855\",\n  \"Type B\", \"#E86A50\",\n  \"Type C\", \"#5A8A6F\",\n  \"#999999\"\n)\n\ncpal_mapgl() |>\n  add_fill_layer(\n    id = \"background\",\n    source = nc,\n    fill_color = \"#EBEBEB\",\n    fill_outline_color = \"#FFFFFF\"\n  ) |>\n  add_circle_layer(\n    id = \"locations\",\n    source = sample_points,\n    circle_color = category_colors,\n    circle_radius = 8,\n    circle_opacity = 0.9,\n    circle_stroke_color = \"#FFFFFF\",\n    circle_stroke_width = 2,\n    popup = \"name\",\n    tooltip = \"category\"\n  ) |>\n  add_legend(\n    \"Category\",\n    values = c(\"Type A\", \"Type B\", \"Type C\"),\n    colors = c(\"#004855\", \"#E86A50\", \"#5A8A6F\"),\n    type = \"categorical\",\n    style = cpal_legend_style()\n  ) |>\n  fit_bounds(nc)\n```\n:::\n\n\n![Points colored by category with styled legend](images/maps/points-colored.png){fig-alt=\"Point map with points colored by category using CPAL colors\"}\n\n### Sized by Value\n\nEncode a numeric variable in circle size:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\ncpal_mapgl() |>\n  add_fill_layer(\n    id = \"background\",\n    source = nc,\n    fill_color = \"#EBEBEB\",\n    fill_outline_color = \"#FFFFFF\"\n  ) |>\n  add_circle_layer(\n    id = \"locations\",\n    source = sample_points,\n    circle_color = \"#004855\",\n    circle_radius = list(\n      \"interpolate\", list(\"linear\"),\n      list(\"get\", \"value\"),\n      100, 5,\n      500, 12,\n      1000, 20\n    ),\n    circle_opacity = 0.7,\n    circle_stroke_color = \"#FFFFFF\",\n    circle_stroke_width = 1,\n    popup = \"name\",\n    tooltip = \"value\"\n  ) |>\n  fit_bounds(nc)\n```\n:::\n\n\n![Points sized by value](images/maps/points-sized.png){fig-alt=\"Point map with circle sizes proportional to values\"}\n\n## Popups & Tooltips\n\nBoth `add_fill_layer()` and `add_circle_layer()` support interactive popups (click) and tooltips (hover).\n\n| Parameter | Behavior |\n|-----------|----------|\n| `popup` | Shows on click. Pass a column name or HTML string column. |\n| `tooltip` | Shows on hover. Pass a column name. |\n\n### Styled Popups with Metrics\n\nUse `cpal_popup_html_metrics()` to create rich, branded popup content with key metrics, and `add_cpal_popup_style()` to style the popup container:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\nlibrary(dplyr)\n\n# Add styled popup column to data\n# Use rowwise() so metrics are evaluated per-row\nnc <- nc |>\n  rowwise() |>\n  mutate(\n    popup_metrics = cpal_popup_html_metrics(\n      title = NAME,\n      subtitle = \"County\",\n      metrics = c(\n        \"Population\" = scales::comma(population),\n        \"Poverty Rate\" = paste0(poverty_rate, \"%\"),\n        \"Area\" = paste0(round(AREA, 1), \" sq mi\")\n      ),\n      footer = \"Source: US Census Bureau\"\n    )\n  ) |>\n  ungroup()\n\n# Use in map with popup styling\ncpal_mapgl() |>\n  add_fill_layer(\n    id = \"counties\",\n    source = nc,\n    fill_color = color_scale$expression,\n    fill_opacity = 0.7,\n    popup = \"popup_metrics\",\n    tooltip = \"NAME\"\n  ) |>\n  add_cpal_popup_style() |>\n  add_legend(\n    \"Poverty Rate (%)\",\n    values = get_legend_labels(color_scale, digits = 1),\n    colors = get_legend_colors(color_scale),\n    type = \"continuous\",\n    style = cpal_legend_style()\n  ) |>\n  fit_bounds(nc)\n```\n:::\n\n\n![Map with CPAL-styled popup showing metrics](images/maps/popup-cpal-metrics.png){fig-alt=\"Choropleth map with styled popup displaying key metrics\"}\n\n### Popup Functions\n\n| Function | Purpose |\n|----------|---------|\n| `cpal_popup_html_metrics()` | Generate popup HTML with title, subtitle, metrics table, and footer |\n| `add_cpal_popup_style()` | Apply CPAL styling to popup container (background, border, shadow) |\n\n## Legend Styling\n\nUse `cpal_legend_style()` to apply consistent CPAL branding to map legends.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"false\"}\ncpal_legend_style(\n  theme = c(\"light\", \"dark\"),\n  position = c(\"bottom-right\", \"bottom-left\", \"top-right\", \"top-left\"),\n  width = 180\n)\n```\n:::\n\n\n| Argument | Description |\n|----------|-------------|\n| `theme` | Match your map theme: `\"light\"` or `\"dark\"` |\n| `position` | Legend placement on map |\n| `width` | Legend width in pixels |\n\nThe style includes CPAL typography (Inter font), appropriate colors, subtle shadow, and proper spacing.\n\n## Dark Theme Example\n\nFor dark-themed dashboards, use matching dark styles for the map, legend, and popups. The coral palette works well on dark backgrounds. Key tips:\n\n- **Use `fill_opacity = 1.0`** to prevent the dark basemap from blending through and muting colors\n- **Reverse the palette** so lighter shades represent higher values (more visible on dark backgrounds)\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Use coral palette, reversed so lighter = higher values\ncoral_colors <- cpal_colors(\"coral_seq_5\", reverse = TRUE)\ncolor_scale_dark <- interpolate_palette(\n  data = nc,\n  column = \"poverty_rate\",\n  method = \"quantile\",\n  n = 5,\n  colors = coral_colors\n)\n\n# Create dark popup content (use rowwise for per-row evaluation)\nnc <- nc |>\n  rowwise() |>\n  mutate(\n    popup_dark = cpal_popup_html_metrics(\n      title = NAME,\n      subtitle = \"County\",\n      metrics = c(\"Poverty Rate\" = paste0(poverty_rate, \"%\")),\n      theme = \"dark\"\n    )\n  ) |>\n  ungroup()\n\n# Complete dark theme map\ncpal_mapgl(theme = \"dark\") |>\n  add_fill_layer(\n    id = \"poverty\",\n    source = nc,\n    fill_color = color_scale_dark$expression,\n    fill_opacity = 1.0,  # Full opacity prevents dark basemap bleed-through\n    fill_outline_color = \"#333333\",\n    popup = \"popup_dark\",\n    tooltip = \"NAME\"\n  ) |>\n  add_cpal_popup_style(theme = \"dark\") |>\n  add_legend(\n    \"Poverty Rate (%)\",\n    values = get_legend_labels(color_scale_dark, digits = 1),\n    colors = get_legend_colors(color_scale_dark),\n    type = \"continuous\",\n    style = cpal_legend_style(theme = \"dark\")\n  ) |>\n  fit_bounds(nc)\n```\n:::\n\n\n![Complete dark theme example with coral palette](images/maps/dark-theme-styled.png){fig-alt=\"Dark theme map with coral color scale, styled legend, and dark popup\"}\n\n## Emissive Strength for 3D Lighting\n\nWhen using mapgl's 3D features or dark themes, you can enhance layer visibility with **emissive strength** properties. These make colors appear to emit light, which is especially effective on dark basemaps.\n\n### Emissive Properties by Layer Type\n\n| Layer Type | Emissive Property | Example |\n|------------|-------------------|---------|\n| Fill (polygons) | `fill_emissive_strength` | Choropleth maps |\n| Circle (points) | `circle_emissive_strength` | Point maps |\n| Line | `line_emissive_strength` | Route/path maps |\n| Symbol/Icon | `icon_emissive_strength` | Marker icons |\n| Text | `text_emissive_strength` | Labels |\n\n### Recommended Values\n\n- **`1.0`** - Full emissive strength, colors appear vibrant and luminous\n- **`0.5`** - Subtle glow effect\n- **`0.0`** - No emissive effect (default)\n\n### Example: Dark Theme with Emissive Fill\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\ncpal_mapgl(theme = \"dark\") |>\n  add_fill_layer(\n    id = \"regions\",\n    source = nc,\n    fill_color = color_scale$expression,\n    fill_opacity = 1.0,\n    fill_emissive_strength = 1.0,  # Makes colors glow\n    fill_outline_color = \"#333333\"\n  ) |>\n  fit_bounds(nc)\n```\n:::\n\n\n### Example: Points with Emissive Glow\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\ncpal_mapgl(theme = \"dark\") |>\n  add_circle_layer(\n    id = \"locations\",\n    source = sample_points,\n    circle_color = \"#E86A50\",\n    circle_radius = 10,\n    circle_emissive_strength = 1.0,  # Points appear to glow\n    circle_stroke_color = \"#FFFFFF\",\n    circle_stroke_width = 1\n  ) |>\n  fit_bounds(nc)\n```\n:::\n\n\n::: {.callout-tip}\n## When to Use Emissive Strength\nEmissive strength is most impactful on **dark theme** maps where standard colors can appear muted. On light themes, the effect is less noticeable since the basemap is already bright.\n:::\n\n## Static Maps with ggplot2\n\nFor static maps in reports and presentations, use `theme_cpal_map()` with ggplot2 and sf.\n\n### Choropleth\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\np1 <- ggplot(nc) +\n  geom_sf(aes(fill = poverty_rate), color = \"white\", linewidth = 0.2) +\n  scale_fill_cpal(palette = \"midnight_seq_5\", discrete = FALSE) +\n  labs(\n    title = \"Simulated Poverty Rate by County\",\n    subtitle = \"North Carolina\",\n    fill = \"Poverty Rate (%)\"\n  ) +\n  theme_cpal_map() +\n  theme(\n    legend.title.position = \"top\",\n    legend.title = element_text(hjust = 0.5)\n  )\n\nadd_cpal_logo(p1)\n```\n\n::: {.cell-output-display}\n![](maps-geographic_files/figure-html/static-map-example-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n### Point Overlay\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"true\"}\np2 <- ggplot() +\n  geom_sf(data = nc, fill = \"#EBEBEB\", color = \"white\") +\n  geom_sf(data = sample_points, aes(color = category), size = 3) +\n  scale_color_cpal(palette = \"main\") +\n  labs(\n    title = \"Sample Locations\",\n    color = \"Category\"\n  ) +\n  theme_cpal_map() +\n  theme(\n    legend.title.position = \"top\",\n    legend.title = element_text(hjust = 0.5)\n  )\n\nadd_cpal_logo(p2)\n```\n\n::: {.cell-output-display}\n![](maps-geographic_files/figure-html/static-points-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n## Troubleshooting\n\n### Map Not Displaying\n\n**Check Mapbox token:**\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Should return your token, not empty string\nSys.getenv(\"MAPBOX_PUBLIC_TOKEN\")\n```\n:::\n\n\n**Verify sf data is valid:**\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Check CRS\nsf::st_crs(my_data)\n\n# Transform to WGS84 if needed\nmy_data <- sf::st_transform(my_data, 4326)\n```\n:::\n\n\n### Slow Rendering\n\nFor large datasets, simplify geometries:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Simplify with sf\ndata_simple <- sf::st_simplify(my_data, dTolerance = 100)\n\n# Or use rmapshaper for better results\ndata_simple <- rmapshaper::ms_simplify(my_data, keep = 0.1)\n```\n:::\n\n\n### Colors Not Showing\n\nEnsure you're passing the expression from `interpolate_palette()`:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Correct - use $expression\nfill_color = color_scale$expression\n\n# Incorrect - don't pass the whole object\nfill_color = color_scale\n```\n:::\n\n\n## Function Reference\n\n| Function | Purpose |\n|----------|---------|\n| `cpal_mapgl()` | Initialize CPAL-themed Mapbox GL map |\n| `cpal_legend_style()` | Get styled legend options for `add_legend()` |\n| `cpal_popup_html_metrics()` | Generate popup HTML with metrics |\n| `add_cpal_popup_style()` | Apply CPAL styling to popup container |\n\n## Next Steps\n\n- [Colors & Palettes](colors-palettes.qmd) - Complete color system documentation\n- [Themes & Styling](themes-styling.qmd) - ggplot2 theme customization\n- [mapgl Documentation](https://walker-data.com/mapgl/) - Full mapgl package reference\n",
    "supporting": [
      "maps-geographic_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}