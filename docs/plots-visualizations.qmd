---
title: "Plots & Output"
subtitle: "Creating and exporting CPAL visualizations"
---

```{r}
#| label: setup
#| include: false
library(cpaltemplates)
library(ggplot2)
library(dplyr)
```

## Overview

This guide covers the utility functions for saving plots, adding branding elements, and ensuring accessibility in your visualizations.

---

## Plot Examples

Before diving into the utility functions, here are some complete examples of CPAL-styled visualizations:

### Scatter Plot with Regression

```{r}
#| label: scatter-example
#| fig-cap: "Scatter plot with trend line"
ggplot(mtcars, aes(x = wt, y = mpg, color = factor(cyl))) +
  geom_point(size = 3, alpha = 0.8) +
  geom_smooth(method = "lm", se = TRUE, alpha = 0.2) +
  scale_color_cpal("main_3") +
  labs(
    title = "Vehicle Fuel Efficiency",
    subtitle = "Weight vs. MPG by cylinder count",
    x = "Weight (1000 lbs)",
    y = "Miles per Gallon",
    color = "Cylinders",
    caption = "Source: Motor Trend, 1974"
  ) +
  theme_cpal()
```

### Bar Chart

```{r}
#| label: bar-example
#| fig-cap: "Bar chart with CPAL colors"
mtcars |>
  count(cyl) |>
  ggplot(aes(x = factor(cyl), y = n, fill = factor(cyl))) +
  geom_col(alpha = 0.9) +
  geom_text(aes(label = n), vjust = -0.5, fontface = "bold", color = "#444444") +
  scale_fill_cpal("main_3") +
  labs(
    title = "Vehicle Count by Cylinder",
    x = "Number of Cylinders",
    y = "Count"
  ) +
  theme_cpal() +
  theme(legend.position = "none")
```

### Box Plot

```{r}
#| label: boxplot-example
#| fig-cap: "Box plot comparing distributions"
ggplot(mtcars, aes(x = factor(cyl), y = mpg, fill = factor(cyl))) +
  geom_boxplot(alpha = 0.8, outlier.shape = 21) +
  scale_fill_cpal("main_3") +
  labs(
    title = "Fuel Efficiency Distribution",
    subtitle = "By cylinder count",
    x = "Cylinders",
    y = "Miles per Gallon"
  ) +
  theme_cpal() +
  theme(legend.position = "none")
```

### Line Chart

```{r}
#| label: line-example
#| fig-cap: "Line chart with multiple series"
# Create time series-like data
line_data <- data.frame(
  year = rep(2018:2023, 3),
  value = c(
    cumsum(rnorm(6, 5, 2)),
    cumsum(rnorm(6, 4, 2)),
    cumsum(rnorm(6, 3, 2))
  ),
  group = rep(c("Series A", "Series B", "Series C"), each = 6)
)

ggplot(line_data, aes(x = year, y = value, color = group)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 3) +
  scale_color_cpal("main_3") +
  labs(
    title = "Trend Over Time",
    subtitle = "Multiple series comparison",
    x = "Year",
    y = "Value",
    color = "Series"
  ) +
  theme_cpal()
```

---

## Saving Plots

### `save_cpal_plot()`

Save plots with standardized CPAL dimensions and settings.

```r
save_cpal_plot(
  plot,
  filename,
  size = "default",
  dpi = 300,
  bg = "white",
  ...
)
```

#### Arguments

| Argument | Description |
|----------|-------------|
| `plot` | A ggplot2 object |
| `filename` | Output filename (extension determines format) |
| `size` | Preset name or custom `c(width, height)` in inches |
| `dpi` | Resolution (default: 300) |
| `bg` | Background color (default: "white") |
| `...` | Additional arguments passed to `ggsave()` |

#### Size Presets

| Preset | Dimensions (inches) | Aspect Ratio | Use Case |
|--------|--------------------:|:------------:|----------|
| `default` | 8 × 5 | 16:10 | General purpose |
| `slide` | 10 × 5.625 | 16:9 | Presentations |
| `half` | 4 × 3 | 4:3 | Half-page figures |
| `third` | 2.5 × 2 | 5:4 | Small inline figures |
| `square` | 5 × 5 | 1:1 | Square format |
| `wide` | 12 × 4 | 3:1 | Panoramic charts |
| `tall` | 5 × 8 | 5:8 | Vertical format |

#### Examples

```r
library(cpaltemplates)
library(ggplot2)

p <- ggplot(mtcars, aes(x = wt, y = mpg, color = factor(cyl))) +
  geom_point(size = 3) +
  scale_color_cpal("main_3") +
  labs(title = "Fuel Efficiency") +
  theme_cpal()

# Save with default size
save_cpal_plot(p, "efficiency_plot.png")

# Save for presentations
save_cpal_plot(p, "efficiency_slide.png", size = "slide")

# Custom dimensions
save_cpal_plot(p, "efficiency_custom.png", size = c(10, 6))

# Higher resolution for print
save_cpal_plot(p, "efficiency_print.png", size = "default", dpi = 600)

# PDF output
save_cpal_plot(p, "efficiency.pdf", size = "default")

# Transparent background
save_cpal_plot(p, "efficiency_transparent.png", bg = "transparent")
```

---

## Adding Branding

### `add_cpal_logo()`

Add the CPAL logo to any ggplot2 visualization.

```r
add_cpal_logo(
  plot,
  position = c("top-right", "top-left", "bottom-right", "bottom-left"),
  size = 0.09,
  logo_path = NULL
)
```

#### Arguments

| Argument | Description |
|----------|-------------|
| `plot` | A ggplot2 object |
| `position` | Logo placement |
| `size` | Logo size as proportion of plot (0-1) |
| `logo_path` | Custom logo path (auto-detects CPAL logo) |

#### Features

- **Auto-detection**: Automatically uses white logo for dark themes
- **Proper sizing**: Maintains aspect ratio
- **Non-intrusive**: Places logo outside the plot area

#### Examples

**Default position (top-right):**

```{r}
#| label: logo-default
#| fig-cap: "Plot with CPAL logo in default position"
p <- ggplot(mtcars, aes(x = wt, y = mpg)) +
  geom_point(color = "#006878", size = 3) +
  labs(
    title = "Vehicle Fuel Efficiency",
    x = "Weight (1000 lbs)",
    y = "Miles per Gallon"
  ) +
  theme_cpal()

add_cpal_logo(p)
```

**Changing position when logo overlaps data:**

If the default top-right position overlaps your data, try a different corner:

```{r}
#| label: logo-positions
#| fig-cap: "Comparing logo positions"
#| layout-ncol: 2
#| fig-height: 4

# Data concentrated in top-right - use bottom-left
p_topright <- ggplot(mtcars, aes(x = wt, y = mpg)) +
  geom_point(color = "#006878", size = 3) +
  labs(title = "Bottom-Left Logo", subtitle = "Best when data is in top-right") +
  theme_cpal()

print(add_cpal_logo(p_topright, position = "bottom-left"))

# Data concentrated in bottom-left - use top-right
p_bottomleft <- ggplot(mtcars, aes(x = mpg, y = wt)) +
  geom_point(color = "#E86A50", size = 3) +
  labs(title = "Top-Right Logo", subtitle = "Best when data is in bottom-left") +
  theme_cpal()

print(add_cpal_logo(p_bottomleft, position = "top-right"))
```

**Adjusting logo size:**

```{r}
#| label: logo-sizes
#| fig-cap: "Different logo sizes"
#| layout-ncol: 2
#| fig-height: 4

p_base <- ggplot(mtcars, aes(x = wt, y = mpg)) +
  geom_point(color = "#006878", size = 3) +
  theme_cpal()

# Smaller logo (0.06)
print(add_cpal_logo(p_base + labs(title = "Smaller Logo (size = 0.06)"),
              position = "bottom-right", size = 0.06))

# Larger logo (0.12)
print(add_cpal_logo(p_base + labs(title = "Larger Logo (size = 0.12)"),
              position = "bottom-right", size = 0.12))
```

**Dark theme (auto-selects white logo):**

```{r}
#| label: logo-dark
#| fig-cap: "Logo automatically adapts to dark theme"
p_dark <- ggplot(mtcars, aes(x = wt, y = mpg, color = factor(cyl))) +
  geom_point(size = 3) +
  scale_color_cpal("main_3") +
  labs(
    title = "Dark Theme with Logo",
    subtitle = "White logo is automatically selected",
    color = "Cylinders"
  ) +
  theme_cpal_dark()

add_cpal_logo(p_dark, position = "bottom-right")
```

**Custom logo path:**

```r
# Use your own logo
p_custom <- add_cpal_logo(p, logo_path = "path/to/custom_logo.png")
```

---

## Accessibility Checking

### `check_plot_accessibility()`

Analyze a plot for accessibility issues.

```r
check_plot_accessibility(plot, verbose = TRUE)
```

#### What It Checks

1. **Text Size**: Ensures text elements are large enough to read
2. **Color Contrast**: Validates colors against WCAG standards
3. **Colorblind Safety**: Checks if colors are distinguishable
4. **Data-to-Ink Ratio**: Identifies unnecessary visual elements

#### Examples

```r
p <- ggplot(mtcars, aes(x = wt, y = mpg, color = factor(cyl))) +
  geom_point() +
  scale_color_cpal("main_3") +
  theme_cpal()

# Run accessibility check
check_plot_accessibility(p)
#> Checking plot accessibility...
#>
#> ── Text Size ──
#> ✓ Title size: 18pt (OK)
#> ✓ Axis text size: 12pt (OK)
#> ✓ Legend text size: 12pt (OK)
#>
#> ── Color Contrast ──
#> ✓ All colors pass WCAG AA on white background
#>
#> ── Colorblind Safety ──
#> ✓ Color palette is distinguishable for common colorblindness types
#>
#> Overall: PASS

# Quiet mode (returns TRUE/FALSE)
is_accessible <- check_plot_accessibility(p, verbose = FALSE)
```

---

## Workflow: Complete Plot Creation

### Step-by-Step Example

```r
library(cpaltemplates)
library(ggplot2)
library(dplyr)

# 1. Prepare data
plot_data <- mtcars |>
  mutate(
    cylinders = factor(cyl),
    transmission = ifelse(am == 1, "Manual", "Automatic")
  )

# 2. Create the visualization
p <- ggplot(plot_data, aes(x = wt, y = mpg, color = cylinders)) +
  geom_point(size = 3, alpha = 0.8) +
  scale_color_cpal("main_3") +
  labs(
    title = "Fuel Efficiency by Vehicle Weight",
    subtitle = "Analysis of 32 automobile models",
    x = "Weight (1,000 lbs)",
    y = "Miles per Gallon",
    color = "Cylinders",
    caption = "Source: Motor Trend, 1974"
  ) +
  theme_cpal()

# 3. Check accessibility
check_plot_accessibility(p)

# 4. Add branding
p_branded <- add_cpal_logo(p, position = "top-right")

# 5. Save in multiple formats
save_cpal_plot(p_branded, "efficiency_report.png", size = "default")
save_cpal_plot(p_branded, "efficiency_slide.png", size = "slide")
save_cpal_plot(p_branded, "efficiency_print.pdf", size = "default", dpi = 600)
```

---

## Size Selection Guide

### By Output Context

| Context | Recommended Size | Notes |
|---------|-----------------|-------|
| PowerPoint slide | `"slide"` | 16:9 aspect ratio |
| Word document (full width) | `"default"` | Good for letter-size |
| Word document (half page) | `"half"` | Side-by-side layouts |
| PDF report | `"default"` | Standard dimensions |
| Email/web | `"default"` or `"slide"` | Good balance |
| Social media | `"square"` | Instagram, Twitter |
| Dashboard | `"wide"` | Horizontal layouts |
| Infographic | `"tall"` | Vertical scrolling |

### DPI Guidelines

| Output | Recommended DPI |
|--------|-----------------|
| Screen/web | 72-150 |
| Standard print | 300 |
| High-quality print | 600 |
| Large format | 150-300 |

```r
# Web/screen
save_cpal_plot(p, "web.png", dpi = 150)

# Print quality
save_cpal_plot(p, "print.png", dpi = 300)

# High-res print
save_cpal_plot(p, "highres.png", dpi = 600)
```

---

## Output Formats

### Supported Formats

| Extension | Type | Best For |
|-----------|------|----------|
| `.png` | Raster | Web, presentations, general use |
| `.jpg` | Raster | Photos, web (smaller files) |
| `.pdf` | Vector | Print, publications, scaling |
| `.svg` | Vector | Web, interactive, scaling |
| `.eps` | Vector | LaTeX, professional printing |
| `.tiff` | Raster | High-quality print, archival |

### Format Selection

```r
# PNG for web/presentations (most common)
save_cpal_plot(p, "plot.png")

# PDF for print/publications
save_cpal_plot(p, "plot.pdf")

# SVG for web with scaling
save_cpal_plot(p, "plot.svg")

# TIFF for journals requiring it
save_cpal_plot(p, "plot.tiff", dpi = 600)
```

---

## Common Patterns

### Batch Processing

```r
library(purrr)

# Create multiple plots
plots <- list(
  cyl4 = filter(mtcars, cyl == 4),
  cyl6 = filter(mtcars, cyl == 6),
  cyl8 = filter(mtcars, cyl == 8)
) |>
  map(~{
    ggplot(.x, aes(x = wt, y = mpg)) +
      geom_point(color = "#007A8C") +
      theme_cpal()
  })

# Save all plots
iwalk(plots, ~{
  save_cpal_plot(.x, paste0("efficiency_", .y, ".png"))
})
```

### Report Figure Set

```r
# Create consistent figures for a report
create_report_figure <- function(data, title, filename) {
  p <- ggplot(data, aes(x = wt, y = mpg)) +
    geom_point(color = "#007A8C") +
    labs(title = title) +
    theme_cpal_print()

  p_logo <- add_cpal_logo(p, position = "bottom-right", size = 0.07)

  save_cpal_plot(p_logo, filename, size = "default", dpi = 300)

  invisible(p_logo)
}

# Generate figures
create_report_figure(mtcars, "Figure 1: All Vehicles", "fig1.png")
create_report_figure(filter(mtcars, cyl == 4), "Figure 2: 4-Cylinder", "fig2.png")
```

### Presentation Deck

```r
# Create slides-ready plots
slides <- list(
  list(data = mtcars, title = "Overview"),
  list(data = filter(mtcars, am == 1), title = "Manual Transmission"),
  list(data = filter(mtcars, am == 0), title = "Automatic Transmission")
)

for (i in seq_along(slides)) {
  p <- ggplot(slides[[i]]$data, aes(x = wt, y = mpg, color = factor(cyl))) +
    geom_point(size = 4) +
    scale_color_cpal("main_3") +
    labs(title = slides[[i]]$title) +
    theme_cpal(base_size = 20)  # Larger for slides

  save_cpal_plot(p, sprintf("slide_%02d.png", i), size = "slide")
}
```

---

## Troubleshooting

### Logo Not Appearing

```r
# Check that cowplot is installed
if (!requireNamespace("cowplot", quietly = TRUE)) {
  install.packages("cowplot")
}

# Check that magick is installed
if (!requireNamespace("magick", quietly = TRUE)) {
  install.packages("magick")
}
```

### Fonts Not Rendering in Saved Files

```r
# Ensure fonts are registered before saving
setup_cpal_google_fonts()

# For PDF output, use Cairo device
save_cpal_plot(p, "plot.pdf", device = cairo_pdf)
```

### File Size Too Large

```r
# Reduce DPI for web
save_cpal_plot(p, "plot.png", dpi = 150)

# Use JPEG for photos
save_cpal_plot(p, "plot.jpg", quality = 85)

# Simplify the plot
p_simple <- p + theme(panel.grid = element_blank())
save_cpal_plot(p_simple, "plot.png")
```

---

## Next Steps

- [Colors & Palettes](colors-palettes.qmd) - Color system reference
- [Themes & Styling](themes-styling.qmd) - Theme customization
- [Interactive Features](interactive-features.qmd) - Creating interactive plots
