---
title: "Workflows"
subtitle: "End-to-end examples and integration patterns"
---

## Overview

This guide provides complete workflow examples showing how to use cpaltemplates in real-world scenarios.

---

## Workflow 1: Data Analysis Report

### Objective

Create a branded analysis report with visualizations, tables, and documentation.

### Project Setup

```r
library(cpaltemplates)

# Create project structure
start_project(
  "housing-analysis-2024",
  project_type = "analysis",
  features = c("git", "renv", "targets")
)

# Add Quarto report capability
use_quarto_report()
```

### Analysis Script

```r
# R/analysis.R
library(cpaltemplates)
library(ggplot2)
library(dplyr)

# Setup
setup_cpal_google_fonts()
set_theme_cpal()

# Load data
data <- read.csv("data/housing_data.csv")

# Create summary
summary_stats <- data |>
  group_by(region) |>
  summarise(
    n = n(),
    avg_price = mean(price),
    median_price = median(price),
    .groups = "drop"
  )

# Visualization 1: Price distribution
p1 <- ggplot(data, aes(x = price, fill = region)) +
  geom_histogram(bins = 30, alpha = 0.7) +
  scale_fill_cpal("main_3") +
  labs(
    title = "Housing Price Distribution",
    subtitle = "By region",
    x = "Price ($)",
    y = "Count"
  ) +
  theme_cpal()

save_cpal_plot(p1, "output/figures/price_distribution.png")

# Visualization 2: Trend over time
p2 <- ggplot(data, aes(x = date, y = price, color = region)) +
  geom_line(linewidth = 1) +
  scale_color_cpal("main_3") +
  labs(
    title = "Housing Price Trends",
    x = "Date",
    y = "Average Price ($)"
  ) +
  theme_cpal()

save_cpal_plot(p2, "output/figures/price_trends.png", size = "wide")

# Create summary table
summary_table <- summary_stats |>
  cpal_table_gt(
    title = "Housing Statistics by Region",
    source = "Source: CPAL Housing Analysis 2024"
  )

gtsave(summary_table, "output/tables/summary.html")
```

### Quarto Report

```markdown
---
title: "Dallas Housing Analysis"
author: "CPAL Data Team"
date: today
format:
  html:
    theme: _brand.yml
---

## Key Findings

![Price Distribution](output/figures/price_distribution.png)

## Trends

![Price Trends](output/figures/price_trends.png)

## Data Summary

```r
cpal_table_gt(summary_stats)
```

---

## Workflow 2: Shiny Dashboard

### Objective

Build an interactive dashboard for data exploration.

### Project Setup

```r
start_project(
  "data-explorer",
  project_type = "shiny-dashboard",
  features = c("git", "renv")
)
```

### app.R

```r
library(shiny)
library(bslib)
library(ggplot2)
library(ggiraph)
library(cpaltemplates)

# Data
data <- mtcars |>
  mutate(
    name = rownames(mtcars),
    cylinders = factor(cyl),
    transmission = ifelse(am == 1, "Manual", "Automatic")
  )

# UI
ui <- page_navbar(
  theme = cpal_dashboard_theme(),
  title = "Vehicle Data Explorer",

  nav_panel(
    "Overview",
    layout_columns(
      col_widths = c(4, 4, 4),
      value_box("Vehicles", nrow(data), showcase = bsicons::bs_icon("car-front")),
      value_box("Avg MPG", round(mean(data$mpg), 1), showcase = bsicons::bs_icon("speedometer")),
      value_box("Avg HP", round(mean(data$hp), 0), showcase = bsicons::bs_icon("lightning"))
    ),
    card(
      full_screen = TRUE,
      card_header("Fuel Efficiency Analysis"),
      girafeOutput("main_plot")
    )
  ),

  nav_panel(
    "Data Table",
    card(
      card_header("Vehicle Database"),
      reactableOutput("data_table")
    )
  )
)

# Server
server <- function(input, output, session) {

  output$main_plot <- renderGirafe({
    p <- ggplot(data, aes(x = wt, y = mpg, color = cylinders)) +
      geom_point_interactive(
        aes(
          tooltip = paste0(
            "<strong>", name, "</strong><br>",
            "MPG: ", mpg, "<br>",
            "HP: ", hp
          ),
          data_id = cylinders
        ),
        size = 4
      ) +
      scale_color_cpal("main_3") +
      labs(
        title = "Weight vs. Fuel Efficiency",
        x = "Weight (1000 lbs)",
        y = "Miles per Gallon"
      ) +
      theme_cpal()

    cpal_interactive(p)
  })

  output$data_table <- renderReactable({
    cpal_table_reactable(
      data,
      searchable = TRUE,
      pagination = TRUE,
      page_size = 15
    )
  })
}

shinyApp(ui, server)
```

---

## Workflow 3: Quarterly Report Automation

### Objective

Automate quarterly report generation with consistent branding.

### Project Setup

```r
start_project(
  "quarterly-reports",
  project_type = "analysis",
  features = c("git", "renv", "targets")
)
```

### _targets.R

```r
library(targets)
library(tarchetypes)
library(cpaltemplates)

tar_option_set(
  packages = c("cpaltemplates", "ggplot2", "dplyr", "gt")
)

list(
  # Load data
  tar_target(
    raw_data,
    read.csv("data/quarterly_metrics.csv")
  ),

  # Process data
  tar_target(
    processed_data,
    raw_data |>
      mutate(
        quarter = paste0("Q", quarter, " ", year),
        change = value - lag(value)
      )
  ),

  # Create visualizations
  tar_target(
    trend_plot,
    {
      p <- ggplot(processed_data, aes(x = quarter, y = value, group = 1)) +
        geom_line(color = "#007A8C", linewidth = 1.2) +
        geom_point(color = "#007A8C", size = 3) +
        labs(
          title = "Quarterly Performance",
          x = "Quarter",
          y = "Value"
        ) +
        theme_cpal()

      save_cpal_plot(p, "output/trend.png")
      p
    }
  ),

  # Create summary table
  tar_target(
    summary_table,
    processed_data |>
      tail(4) |>
      cpal_table_gt(title = "Recent Quarters")
  ),

  # Render report
  tar_quarto(
    report,
    "report.qmd",
    extra_files = c("output/trend.png")
  )
)
```

---

## Workflow 4: Presentation Deck

### Objective

Create presentation slides with branded visualizations.

### Project Setup

```r
start_project(
  "presentation-2024",
  project_type = "quarto-slides"
)
```

### slides.qmd

```markdown
---
title: "CPAL Data Insights"
author: "Data Science Team"
format:
  revealjs:
    theme: _brand.yml
---

## Key Metrics {.smaller}

```r
library(cpaltemplates)

ggplot(mtcars, aes(x = factor(cyl), y = mpg, fill = factor(cyl))) +
  geom_boxplot() +
  scale_fill_cpal("main_3") +
  labs(title = "MPG by Cylinder Count") +
  theme_cpal(base_size = 20) +
  theme(legend.position = "none")
```

## Trends Over Time

```r
# Time series visualization
ggplot(data, aes(x = date, y = value)) +
  geom_line(color = "#007A8C", linewidth = 1.5) +
  theme_cpal_dark(base_size = 20)
```

---

## Workflow 5: Multi-Map Report

### Objective

Create a report with multiple geographic visualizations.

### Map Generation Script

```r
library(cpaltemplates)
library(ggplot2)
library(sf)
library(dplyr)

setup_cpal_google_fonts()

# Load geographic data
tracts <- st_read("data/dallas_tracts.geojson")

# Map 1: Population density
map_pop <- ggplot(tracts) +
  geom_sf(aes(fill = pop_density), color = "white", linewidth = 0.1) +
  scale_fill_cpal_c("teal_seq_5") +
  labs(title = "Population Density", fill = "Pop/sq mi") +
  theme_cpal_map()

save_cpal_plot(map_pop, "maps/population.png")

# Map 2: Poverty rate
map_poverty <- ggplot(tracts) +
  geom_sf(aes(fill = poverty_rate), color = "white", linewidth = 0.1) +
  scale_fill_cpal_c("pink_teal_5") +
  labs(title = "Poverty Rate", fill = "Rate (%)") +
  theme_cpal_map()

save_cpal_plot(map_poverty, "maps/poverty.png")

# Map 3: Change over time
map_change <- ggplot(tracts) +
  geom_sf(aes(fill = pop_change), color = "white", linewidth = 0.1) +
  scale_fill_cpal_c("pink_teal_5") +  # Diverging for change
  labs(title = "Population Change 2020-2024", fill = "Change (%)") +
  theme_cpal_map()

save_cpal_plot(map_change, "maps/change.png")
```

---

## Workflow 6: Package Integration

### Objective

Use cpaltemplates as foundation for internal package.

### Package Structure

```r
# Create package
start_project(
  "cpalreports",
  project_type = "package"
)
```

### R/plot_wrappers.R

```r
#' Create standard CPAL line plot
#' @export
cpal_line_plot <- function(data, x, y, color = NULL, title = NULL) {
  p <- ggplot2::ggplot(data, ggplot2::aes(
    x = .data[[x]],
    y = .data[[y]],
    color = if (!is.null(color)) .data[[color]] else NULL
  )) +
    ggplot2::geom_line(linewidth = 1) +
    cpaltemplates::theme_cpal()

  if (!is.null(color)) {
    p <- p + cpaltemplates::scale_color_cpal("main")
  }

  if (!is.null(title)) {
    p <- p + ggplot2::labs(title = title)
  }

  p
}

#' Create standard CPAL bar plot
#' @export
cpal_bar_plot <- function(data, x, y, fill = NULL, title = NULL) {
  p <- ggplot2::ggplot(data, ggplot2::aes(
    x = .data[[x]],
    y = .data[[y]],
    fill = if (!is.null(fill)) .data[[fill]] else NULL
  )) +
    ggplot2::geom_col() +
    cpaltemplates::theme_cpal()

  if (!is.null(fill)) {
    p <- p + cpaltemplates::scale_fill_cpal("main")
  }

  p
}
```

---

## Best Practices Summary

### 1. Always Set Up Fonts First

```r
# At the start of every script
library(cpaltemplates)
setup_cpal_google_fonts()
```

### 2. Use Consistent Sizing

```r
# Use size presets for consistency
save_cpal_plot(p, "file.png", size = "slide")  # Presentations
save_cpal_plot(p, "file.png", size = "default")  # Reports
```

### 3. Check Accessibility

```r
# Before finalizing visualizations
check_plot_accessibility(p)
```

### 4. Use Version Control for Brand

```r
# Keep _brand.yml tracked
use_cpal_brand()  # Copy to project
# Commit to git
```

### 5. Document Custom Colors

```yaml
# In _brand.yml
color:
  palette:
    # Project-specific colors with comments
    custom_highlight: "#FF6B6B"  # For housing emphasis
```

---

## Next Steps

- [Getting Started](getting-started.qmd) - Initial setup
- [Function Reference](function-reference.qmd) - Complete function list
- [Troubleshooting](troubleshooting.qmd) - Common issues
