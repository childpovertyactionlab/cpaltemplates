---
title: "Troubleshooting"
subtitle: "Common issues and solutions"
---

## Installation Issues

### Package Not Found

```r
# Error: package 'cpaltemplates' is not available
```

**Solution:**

```r
# Install remotes if needed
install.packages("remotes")

# Install with dependencies
remotes::install_github(
  "childpovertyactionlab/cpaltemplates",
  dependencies = TRUE
)
```

### R Version Error

```r
# Error: package requires R >= 4.3.0
```

**Solution:**

Update R to version 4.3.0 or higher. Download from [CRAN](https://cran.r-project.org/).

### Dependency Conflicts

```r
# Error: dependency 'xyz' is not available
```

**Solution:**

```r
# Install dependencies manually
install.packages(c("ggplot2", "bslib", "gt", "reactable", "ggiraph"))

# Then retry
remotes::install_github("childpovertyactionlab/cpaltemplates")
```

---

## Font Issues

### Fonts Not Rendering

**Symptoms:**

- Plots show system fonts instead of Inter/Poppins
- Warning: "font family not found"

**Solutions:**

```r
# 1. Run font setup
setup_cpal_google_fonts(force_refresh = TRUE, verbose = TRUE)

# 2. Check font availability
sysfonts::font_families()

# 3. Verify showtext is enabled
library(showtext)
showtext_auto()

# 4. Check what font is being used
cpal_font_family(setup = TRUE)
```

### Interactive Plot Fonts

**Symptoms:**

- ggiraph plots show wrong fonts
- Fonts work in static plots but not interactive

**Solutions:**

```r
# Install required packages
install.packages(c("gdtools", "systemfonts"))

# Register fonts for interactive use
if (requireNamespace("gdtools", quietly = TRUE)) {
  gdtools::register_gfont("Inter")
  gdtools::register_gfont("Roboto")
}
```

### PDF Font Issues

**Symptoms:**

- Fonts don't appear in PDF output
- PDF shows rectangles instead of text

**Solutions:**

```r
# Use cairo device for better font support
ggsave("plot.pdf", plot, device = cairo_pdf)

# Or use showtext
library(showtext)
showtext_auto()
ggsave("plot.pdf", plot)
```

---

## Theme Issues

### Theme Not Applying

**Symptoms:**

- Plot doesn't have CPAL styling
- Default ggplot2 theme appears

**Solutions:**

```r
# 1. Ensure theme_cpal() is in the plot
ggplot(data, aes(x, y)) +
  geom_point() +
  theme_cpal()  # Must be included!

# 2. Check if theme is being overwritten
# theme_cpal() should be last or near-last
ggplot(data, aes(x, y)) +
  geom_point() +
  other_layer() +
  theme_cpal() +  # After other layers
  theme(specific_override = ...)  # Specific overrides after

# 3. Set default theme for session
set_theme_cpal()
```

### Shiny Theme Not Working

**Symptoms:**

- Dashboard shows default Bootstrap styling
- CPAL colors not appearing

**Solutions:**

```r
# 1. Ensure using bslib page functions
page_sidebar(  # Correct - bslib function
  theme = cpal_dashboard_theme(),
  ...
)

fluidPage(  # Wrong - doesn't support bslib themes fully
  ...
)

# 2. Check bslib is loaded
library(bslib)

# 3. Verify theme is applied
theme <- cpal_dashboard_theme()
print(theme)  # Should show theme details
```

---

## Color Issues

### Colors Not Showing

**Symptoms:**

- `scale_color_cpal()` has no effect
- Default ggplot2 colors appear

**Solutions:**

```r
# 1. Match discrete/continuous to your data
# For categorical data:
scale_color_cpal("main", discrete = TRUE)

# For continuous data:
scale_color_cpal_c("teal_seq_5")

# 2. Check palette name is valid
list_cpal_palettes()

# 3. Verify color aesthetic is mapped
ggplot(data, aes(x, y, color = group)) +  # color must be mapped
  geom_point() +
  scale_color_cpal("main")
```

### Wrong Number of Colors

**Symptoms:**

- "Insufficient values in manual scale" error
- Colors don't match number of categories

**Solutions:**

```r
# Check how many categories you have
n_distinct(data$category)

# Use appropriate palette
# For 3 categories:
scale_color_cpal("main_3")

# For 5 categories:
scale_color_cpal("main_5")

# For 6 categories:
scale_color_cpal("main_6")  # 6 colors
```

### Color Contrast Issues

```r
# Check if colors meet accessibility standards
validate_color_contrast("#007A8C", "#FFFFFF")

# Check all brand colors
validate_brand_colors()
```

---

## Table Issues

### GT Table Not Displaying

**Symptoms:**

- Table doesn't render in viewer
- Error about gt package

**Solutions:**

```r
# 1. Install gt
install.packages("gt")

# 2. Verify installation
library(gt)

# 3. Check data is a data frame
class(your_data)  # Should be "data.frame" or "tbl_df"
```

### Reactable Not Interactive

**Symptoms:**

- Table appears static
- No search/pagination

**Solutions:**

```r
# 1. Install reactable
install.packages("reactable")

# 2. In Shiny, use correct output function
# UI:
reactableOutput("table")

# Server:
output$table <- renderReactable({
  cpal_table_reactable(data)
})
```

---

## Interactive Plot Issues

### ggiraph Not Working

**Symptoms:**

- Plot is static instead of interactive
- Tooltips don't appear

**Solutions:**

```r
# 1. Install ggiraph
install.packages("ggiraph")

# 2. Use interactive geoms
geom_point_interactive()  # Correct
geom_point()              # Won't be interactive

# 3. Wrap with cpal_interactive()
p <- ggplot(data, aes(x, y)) +
  geom_point_interactive(aes(tooltip = label)) +
  theme_cpal()

cpal_interactive(p)  # This renders it interactive
```

### Interactive in Shiny

```r
# Use girafeOutput and renderGirafe
# UI:
girafeOutput("plot")

# Server:
output$plot <- renderGirafe({
  p <- ggplot(...) +
    geom_point_interactive(...)
  cpal_interactive(p)
})
```

---

## Map Issues

### Map Not Displaying

**Symptoms:**

- Empty plot
- Error about sf

**Solutions:**

```r
# 1. Install sf
install.packages("sf")

# 2. Check data is sf object
class(geo_data)  # Should include "sf"

# 3. Verify CRS
sf::st_crs(geo_data)

# 4. Transform if needed
geo_data <- sf::st_transform(geo_data, 4326)
```

### Mapbox Token Issues

```r
# Set token
Sys.setenv(MAPBOX_PUBLIC_TOKEN = "pk.xxx...")

# Verify
Sys.getenv("MAPBOX_PUBLIC_TOKEN")

# Add to .Renviron for persistence
usethis::edit_r_environ()
# Add: MAPBOX_PUBLIC_TOKEN=pk.xxx...
```

---

## Project Scaffolding Issues

### Templates Not Copying

**Symptoms:**

- Project created but missing files
- Error about templates

**Solutions:**

```r
# 1. Reinstall package
remotes::install_github("childpovertyactionlab/cpaltemplates")

# 2. Check templates exist
system.file("templates", package = "cpaltemplates")

# 3. Try with explicit path
start_project(
  "my-project",
  path = normalizePath("~/projects"),
  project_type = "analysis"
)
```

### Project Won't Open

```r
# Disable auto-open
start_project("my-project", open = FALSE)

# Open manually
rstudioapi::openProject("my-project")
```

---

## Brand File Issues

### _brand.yml Not Found

```r
# Copy from package
use_cpal_brand()

# Verify file exists
file.exists("_brand.yml")
```

### Invalid Brand Configuration

```r
# Validate the file
validate_cpal_brand(verbose = TRUE)

# Common issues:
# - Missing # in hex colors: "007A8C" should be "#007A8C"
# - Invalid YAML syntax: check indentation
# - Missing required sections
```

---

## Performance Issues

### Slow Rendering

**Solutions:**

```r
# 1. Reduce DPI for drafts
save_cpal_plot(p, "draft.png", dpi = 100)

# 2. Simplify geometries for maps
geo_simple <- sf::st_simplify(geo_data, dTolerance = 100)

# 3. Sample large datasets
data_sample <- dplyr::slice_sample(large_data, n = 1000)

# 4. Use smaller SVG for interactive
cpal_interactive(p, width_svg = 6, height_svg = 4)
```

### Memory Issues

```r
# Clear environment
rm(list = ls())
gc()

# Use data.table for large files
library(data.table)
data <- fread("large_file.csv")
```

---

## Getting Help

### Check Package Version

```r
packageVersion("cpaltemplates")
```

### Report Issues

[GitHub Issues](https://github.com/childpovertyactionlab/cpaltemplates/issues)

When reporting, include:

1. R version: `R.version.string`
2. Package version: `packageVersion("cpaltemplates")`
3. Operating system
4. Minimal reproducible example
5. Full error message

### Reinstall Clean

```r
# Remove and reinstall
remove.packages("cpaltemplates")
remotes::install_github(
  "childpovertyactionlab/cpaltemplates",
  dependencies = TRUE,
  force = TRUE
)
```

---

## Quick Fixes Checklist

- [ ] Is cpaltemplates loaded? `library(cpaltemplates)`
- [ ] Are fonts set up? `setup_cpal_google_fonts()`
- [ ] Is the theme applied? `theme_cpal()` in plot
- [ ] Are colors mapped? `aes(color = ...)` present
- [ ] Is scale added? `scale_color_cpal()` in plot
- [ ] For interactive: using `_interactive()` geoms?
- [ ] For Shiny: using `page_*()` functions?
- [ ] For maps: is data an sf object?

---

## See Also

- [Getting Started](getting-started.qmd) - Initial setup
- [Function Reference](function-reference.qmd) - All functions
- [Workflows](workflow-integration.qmd) - Complete examples
